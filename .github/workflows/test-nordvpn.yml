name: Test NordVPN Connection

on:
  workflow_dispatch:

jobs:
  test-vpn:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      NORD_TOKEN: ${{ secrets.NORD_TOKEN }}        # your Nord account token
      NORD_COUNTRY: ${{ secrets.NORD_COUNTRY }}    # e.g. ES

    steps:
      - name: Check IP without VPN
        run: |
          echo "=== IP WITHOUT VPN ==="
          curl -s https://ipinfo.io/json | jq -r '.ip, .country, .city, .org'
          echo ""

      - name: Start NordLynx + SOCKS5 proxy (Spain)
        if: ${{ env.NORD_TOKEN != '' && env.NORD_COUNTRY != '' }}
        run: |
          echo "Starting nordlynx-proxy for ${NORD_COUNTRY}"
          docker run -d --name nordlynx-proxy \
            --cap-add=NET_ADMIN --device /dev/net/tun \
            -e NORDVPN_LOGIN="${NORD_TOKEN}" \    # <-- use token here
            -e NORDVPN_PASS="" \                  # <-- empty when using token
            -e COUNTRY="${NORD_COUNTRY}" \
            -e TECHNOLOGY=NordLynx \
            -p 1080:1080 -p 8888:8888 \
            edgd1er/nordlynx-proxy:latest-ubuntu

          echo "Waiting for proxy to be ready..."
          for i in {1..40}; do
            OUT=$(curl -s --max-time 5 -x socks5://127.0.0.1:1080 https://ipinfo.io/ip || true)
            if [[ "$OUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "✅ SOCKS proxy up: $OUT"
              break
            fi
            sleep 2
          done

          # If still not ready, dump useful diagnostics and fail early
          if ! timeout 3 bash -c "echo > /dev/tcp/127.0.0.1/1080" 2>/dev/null; then
            echo "❌ SOCKS port not open; printing diagnostics"
            echo "=== docker ps ==="; docker ps || true
            echo "=== container logs ==="; docker logs nordlynx-proxy || true
            echo "=== nordvpn status ==="; docker exec nordlynx-proxy bash -lc 'nordvpn status || true'
            exit 1
          fi

          # Export proxy for later steps
          echo "PROXY=socks5://127.0.0.1:1080" >> $GITHUB_ENV

      - name: Check IP through VPN (via SOCKS5)
        if: ${{ env.NORD_TOKEN != '' && env.NORD_COUNTRY != '' }}
        run: |
          echo "=== IP THROUGH VPN (via SOCKS5 proxy) ==="
          JSON=$(curl -s -x "$PROXY" --max-time 15 https://ipinfo.io/json) || {
            echo "❌ curl failed through proxy"
            docker logs nordlynx-proxy || true
            exit 1
          }
          echo "$JSON" | jq -r '.ip, .country, .city, .org'
          GOT=$(echo "$JSON" | jq -r '.country // ""')
          EXPECTED=$(echo "$NORD_COUNTRY" | tr a-z A-Z)
          [ "$GOT" = "$EXPECTED" ] && echo "✅ Geo check passed ($EXPECTED)" || { echo "⚠️ Expected $EXPECTED but got $GOT"; exit 1; }

      - name: Test AimHarder connectivity through VPN
        if: ${{ env.NORD_TOKEN != '' && env.NORD_COUNTRY != '' }}
        run: |
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -x "$PROXY" https://aimharder.com)
          echo "AimHarder HTTP response: $CODE"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f nordlynx-proxy || true
          echo "VPN container removed"
