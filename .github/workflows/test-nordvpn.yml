name: Test NordVPN Connection

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-vpn:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      # Set in repo secrets; use ES for Spain
      NORDVPN_TOKEN: ${{ secrets.NORD_TOKEN }}
      NORDVPN_COUNTRY: ${{ secrets.NORD_COUNTRY }}

    steps:
      - name: Check IP without VPN
        run: |
          echo "=== IP WITHOUT VPN ==="
          curl -s https://ipinfo.io/json | jq -r '.ip, .country, .city, .org'
          echo ""

      - name: Start NordLynx + SOCKS5 proxy (Spain)
        if: ${{ env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != '' }}
        run: |
          echo "Starting NordLynx proxy for country: ${NORDVPN_COUNTRY}"
          docker run -d --name nordlynx-proxy \
            --cap-add=NET_ADMIN --device /dev/net/tun \
            -e TOKEN="${NORDVPN_TOKEN}" \
            -e COUNTRY="${NORDVPN_COUNTRY}" \
            -p 1080:1080 -p 3128:3128 \
            edgd1er/nordlynx-proxy:latest-ubuntu

          echo "Waiting for proxy to be ready..."
          for i in {1..40}; do
            OUT=$(curl -s --max-time 5 -x socks5://127.0.0.1:1080 https://ipinfo.io/ip || true)
            if [[ "$OUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "✅ Proxy is up: $OUT"
              break
            fi
            echo "Attempt $i/40..."
            sleep 2
          done

          # Export proxy for later steps
          echo "PROXY=socks5://127.0.0.1:1080" >> $GITHUB_ENV

      - name: Check IP through VPN (via SOCKS5)
        if: ${{ env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != '' }}
        run: |
          echo ""
          echo "=== IP THROUGH VPN (via SOCKS5 proxy) ==="
          CURL_OUTPUT=$(curl -s -x "$PROXY" --max-time 10 https://ipinfo.io/json)
          if [ -z "$CURL_OUTPUT" ]; then
            echo "❌ Proxy didn't return data"
            echo "=== Container logs ==="
            docker logs nordlynx-proxy || true
            exit 1
          fi
          echo "$CURL_OUTPUT" | jq -r '.ip, .country, .city, .org'
          COUNTRY=$(echo "$CURL_OUTPUT" | jq -r '.country // ""')
          EXPECTED=$(echo "$NORDVPN_COUNTRY" | tr '[:lower:]' '[:upper:]')
          if [ "$COUNTRY" != "$EXPECTED" ]; then
            echo "⚠️ Expected $EXPECTED but got $COUNTRY"; exit 1
          fi
          echo "✅ Geo check passed ($EXPECTED)"

      - name: Test AimHarder connectivity through VPN
        if: ${{ env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != '' }}
        run: |
          echo ""
          echo "=== Testing AimHarder.com through VPN ==="
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -x "$PROXY" https://aimharder.com)
          echo "AimHarder HTTP response: $HTTP_CODE"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ AimHarder is accessible through VPN!"
          else
            echo "⚠️ Got HTTP $HTTP_CODE from AimHarder (could still be OK depending on their redirects/CDN)."
          fi

      - name: Cleanup
        if: always()
        run: |
          docker rm -f nordlynx-proxy || true
          echo "VPN container removed"

      - name: No VPN credentials warning
        if: ${{ env.NORDVPN_TOKEN == '' || env.NORDVPN_COUNTRY == '' }}
        run: |
          echo "⚠️ VPN test skipped - missing secrets:"
          echo "Required: NORD_TOKEN, NORD_COUNTRY (e.g., ES)"
