name: Book 7AM Classes (Mon-Fri)

# Schedules cover both UTC offsets (DST/winter). We only "gate" when triggered by cron.
on:
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Run immediately (ignore 19:05 Europe/Madrid gate)'
        type: boolean
        default: true
  schedule:
    - cron: '5 17 * * *'  # matches 19:05 local in summer (UTC+2)
    - cron: '5 18 * * *'  # matches 19:05 local in winter (UTC+1)

jobs:
  book:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PWD }}
      BOX_NAME: ${{ secrets.BOX_NAME }}
      BOX_ID: ${{ secrets.BOX_ID }}
      FAMILY_ID: ${{ secrets.FAMILY_ID }}
      NORDVPN_TOKEN: ${{ secrets.NORD_TOKEN }}
      NORDVPN_COUNTRY: ${{ secrets.NORD_COUNTRY }} # e.g., ES
      BOOKING_GOALS: '{"0":{"time":"0700","name":"CrossFit"},"1":{"time":"0700","name":"CrossFit"},"2":{"time":"0700","name":"CrossFit"},"3":{"time":"0700","name":"CrossFit"},"4":{"time":"0700","name":"CrossFit"}}'
      DAYS_IN_ADVANCE: 2

    steps:
      - name: Decide whether to run
        id: gate
        run: |
          # default: run
          echo "RUN_JOB=true" >> $GITHUB_ENV

          if [ "${{ github.event_name }}" = "schedule" ]; then
            TARGET="19:05"
            NOW=$(TZ=Europe/Madrid date +'%H:%M')
            echo "Scheduled run. Europe/Madrid time is $NOW; target is $TARGET"
            if [ "$NOW" != "$TARGET" ]; then
              echo "RUN_JOB=false" >> $GITHUB_ENV
            fi
          else
            # Manual run: honor the optional toggle
            if [ "${{ inputs.force_run }}" = "false" ]; then
              TARGET="19:05"
              NOW=$(TZ=Europe/Madrid date +'%H:%M')
              echo "Manual run with force_run=false. Local time $NOW, target $TARGET"
              if [ "$NOW" != "$TARGET" ]; then
                echo "RUN_JOB=false" >> $GITHUB_ENV
              fi
            else
              echo "Manual run with force_run=true → proceeding regardless of time."
            fi
          fi

      - name: Checkout repository
        if: env.RUN_JOB == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: env.RUN_JOB == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: env.RUN_JOB == 'true'
        run: pip install .

      - name: Start NordLynx + SOCKS5 proxy (Spain)
        if: env.RUN_JOB == 'true' && env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != ''
        run: |
          echo "Starting NordLynx proxy for country: ${NORDVPN_COUNTRY}"
          docker run -d --name nordlynx-proxy \
            --cap-add=NET_ADMIN --device /dev/net/tun \
            -e NORDVPN_LOGIN="${NORDVPN_TOKEN}" \
            -e NORDVPN_PASS="" \
            -e COUNTRY="${NORDVPN_COUNTRY}" \
            -e TECHNOLOGY=NordLynx \
            -p 1080:1080 -p 8888:8888 \
            edgd1er/nordlynx-proxy:latest-ubuntu
      
          echo "Waiting for SOCKS proxy to be ready on 127.0.0.1:1080 ..."
          for i in {1..40}; do
            OUT=$(curl -s --max-time 5 -x socks5://127.0.0.1:1080 https://ipinfo.io/ip || true)
            if [[ "$OUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "✅ SOCKS proxy up: $OUT"
              READY=1; break
            fi
            echo "Attempt $i/40..."; sleep 2
          done
          if [ -z "$READY" ]; then
            echo "❌ Proxy not ready. Diagnostics:"
            docker ps || true
            docker logs nordlynx-proxy || true
            docker exec nordlynx-proxy bash -lc 'nordvpn status || true' || true
            exit 1
          fi
          echo "PROXY=socks5://127.0.0.1:1080" >> $GITHUB_ENV
      
          echo "Verifying geo-location through proxy..."
          INFO=$(curl -s -x socks5://127.0.0.1:1080 https://ipinfo.io/json || true)
          echo "$INFO" | jq -r '.ip, .country, .city, .org'
          EXPECTED=$(echo "$NORDVPN_COUNTRY" | tr '[:lower:]' '[:upper:]')
          GOT=$(echo "$INFO" | jq -r '.country // ""')
          if [ "$GOT" != "$EXPECTED" ]; then
            echo "⚠️ Expected $EXPECTED but got $GOT"; exit 1
          fi
          echo "✅ VPN geo check passed for $EXPECTED"

      - name: Run booking script
        if: env.RUN_JOB == 'true' && secrets.EMAIL && secrets.PWD && secrets.BOX_NAME && secrets.BOX_ID
        run: |
          echo "Attempting booking for day +${DAYS_IN_ADVANCE} (target weekday)."
          python src/main.py \
            --email "$EMAIL" \
            --password "$PASSWORD" \
            --box-name "$BOX_NAME" \
            --box-id "$BOX_ID" \
            --booking-goals "$BOOKING_GOALS" \
            --days-in-advance "$DAYS_IN_ADVANCE" \
            ${FAMILY_ID:+--family-id "$FAMILY_ID"} \
            ${PROXY:+--proxy "$PROXY"}

      - name: Cleanup NordVPN
        if: always()
        run: |
          docker rm -f nordlynx-proxy || true
          echo "NordVPN container removed"

      - name: Post-run note if skipped/misconfigured
        if: env.RUN_JOB != 'true' || env.EMAIL == '' || env.PASSWORD == '' || env.BOX_NAME == '' || env.BOX_ID == '' || env.NORDVPN_TOKEN == '' || env.NORDVPN_COUNTRY == ''
        run: |
          echo "Skipped or missing secrets. RUN_JOB=${RUN_JOB:-false}. Event=${{ github.event_name }}."
