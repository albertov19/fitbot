name: Book 7AM Classes (Mon-Fri)

# Runs at 19:05 Europe/Madrid two days before the target 07:00 class.
# GitHub cron is UTC; Madrid is UTC+1 in winter and UTC+2 in summer.
# We schedule BOTH 17:05 and 18:05 UTC and gate by local time in the first step.

on:
  workflow_dispatch:
  schedule:
    # 17:05 UTC (summer) and 18:05 UTC (winter) every day
    - cron: '5 17 * * *'
    - cron: '5 18 * * *'

jobs:
  book:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PASSWORD }}
      BOX_NAME: ${{ secrets.BOX_NAME }}
      BOX_ID: ${{ secrets.BOX_ID }}
      FAMILY_ID: ${{ secrets.FAMILY_ID }}
      # VPN (make sure NORD_COUNTRY=ES for Spain)
      NORDVPN_TOKEN: ${{ secrets.NORD_TOKEN }}
      NORDVPN_COUNTRY: ${{ secrets.NORD_COUNTRY }} # e.g., ES
      # Booking goals Mon(0)..Fri(4) at 07:00 named "CrossFit"
      BOOKING_GOALS: '{"0":{"time":"0700","name":"CrossFit"},"1":{"time":"0700","name":"CrossFit"},"2":{"time":"0700","name":"CrossFit"},"3":{"time":"0700","name":"CrossFit"},"4":{"time":"0700","name":"CrossFit"}}'
      DAYS_IN_ADVANCE: 2

    steps:
      - name: Gate by local time (must be 19:05 Europe/Madrid)
        id: gate
        run: |
          TARGET="19:05"
          NOW=$(TZ=Europe/Madrid date +'%H:%M')
          echo "Local Europe/Madrid time is $NOW; target is $TARGET"
          if [ "$NOW" = "$TARGET" ]; then
            echo "RUN_JOB=true" >> $GITHUB_ENV
          else
            echo "RUN_JOB=false" >> $GITHUB_ENV
          fi

      - name: Checkout repository
        if: env.RUN_JOB == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: env.RUN_JOB == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: env.RUN_JOB == 'true'
        run: |
          pip install .

      - name: Start NordLynx + SOCKS5 proxy (Spain)
        if: env.RUN_JOB == 'true' && env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != ''
        run: |
          echo "Starting NordLynx proxy for country: ${NORDVPN_COUNTRY}"
          docker run -d --name nordlynx-proxy \
            --cap-add=NET_ADMIN --device /dev/net/tun \
            -e TOKEN="${NORDVPN_TOKEN}" \
            -e COUNTRY="${NORDVPN_COUNTRY}" \
            -p 1080:1080 -p 3128:3128 \
            edgd1er/nordlynx-proxy:latest-ubuntu

          echo "Waiting for proxy to be ready..."
          for i in {1..30}; do
            # Try via SOCKS5; success when we get an IP back
            OUT=$(curl -s --max-time 5 -x socks5://127.0.0.1:1080 https://ipinfo.io/ip || true)
            if [[ "$OUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "✅ Proxy is up: $OUT"
              break
            fi
            sleep 2
          done

          # Export proxy for the booking script
          echo "PROXY=socks5://127.0.0.1:1080" >> $GITHUB_ENV

          echo "Verifying location through proxy..."
          INFO=$(curl -s -x socks5://127.0.0.1:1080 https://ipinfo.io/json || true)
          echo "$INFO" | jq -r '.ip, .country, .city, .org'
          EXPECTED=$(echo "$NORDVPN_COUNTRY" | tr '[:lower:]' '[:upper:]')
          GOT=$(echo "$INFO" | jq -r '.country // ""')
          if [ "$GOT" != "$EXPECTED" ]; then
            echo "⚠️ Expected $EXPECTED but got $GOT"; exit 1
          fi
          echo "✅ VPN geo check passed for $EXPECTED"

      - name: Run booking script (Mon-Fri only)
        if: env.RUN_JOB == 'true' && env.EMAIL != '' && env.PASSWORD != '' && env.BOX_NAME != '' && env.BOX_ID != '' && env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != ''
        run: |
          # Only attempt on Mon-Fri targets:
          DOW=$(TZ=Europe/Madrid date +%u)         # 1..7 (Mon..Sun)
          if [ "$DOW" -gt 5 ]; then
            echo "It's weekend; skipping."
            exit 0
          fi

          echo "Attempting booking for +${DAYS_IN_ADVANCE} days."
          python src/main.py \
            --email "$EMAIL" \
            --password "$PASSWORD" \
            --box-name "$BOX_NAME" \
            --box-id "$BOX_ID" \
            --booking-goals "$BOOKING_GOALS" \
            --days-in-advance "$DAYS_IN_ADVANCE" \
            ${FAMILY_ID:+--family-id "$FAMILY_ID"} \
            ${PROXY:+--proxy "$PROXY"}

      - name: Cleanup VPN
        if: always()
        run: |
          docker rm -f nordlynx-proxy || true
          echo "VPN container removed"

      - name: Post-run note if skipped/misconfigured
        if: env.RUN_JOB != 'true' || env.EMAIL == '' || env.PASSWORD == '' || env.BOX_NAME == '' || env.BOX_ID == '' || env.NORDVPN_TOKEN == '' || env.NORDVPN_COUNTRY == ''
        run: |
          echo "Skipped or missing secrets. RUN_JOB=${RUN_JOB:-false}"
