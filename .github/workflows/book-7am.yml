name: Book 7AM Classes (Sat–Wed)

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: "Run immediately (ignore 19:05 Europe/Madrid gate)"
        type: boolean
        default: true
  schedule:
    # GitHub Actions cron is UTC. Two entries handle DST; restricted to Sat–Wed.
    - cron: "5 17 * * 6,0-3"  # 19:05 local in summer (UTC+2): Sat, Sun, Mon, Tue, Wed
    - cron: "5 18 * * 6,0-3"  # 19:05 local in winter (UTC+1): Sat, Sun, Mon, Tue, Wed

jobs:
  book:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PWD }}
      BOX_NAME: ${{ secrets.BOX_NAME }}
      BOX_ID: ${{ secrets.BOX_ID }}
      FAMILY_ID: ${{ secrets.FAMILY_ID }}
      NORDVPN_TOKEN: ${{ secrets.NORD_TOKEN }}
      NORDVPN_COUNTRY: ${{ secrets.NORD_COUNTRY }} # e.g., ES
      BOOKING_GOALS: '{"0":{"time":"0700","name":"CrossFit"},"1":{"time":"0700","name":"CrossFit"},"2":{"time":"0700","name":"CrossFit"},"3":{"time":"0700","name":"CrossFit"},"4":{"time":"0700","name":"CrossFit"}}'
      DAYS_IN_ADVANCE: 2

    steps:
      - name: Decide whether to run
        id: gate
        run: |
          echo "RUN_JOB=true" >> "$GITHUB_ENV"

          TARGET_HM="19:05"
          NOW_HM=$(TZ=Europe/Madrid date +'%H:%M')
          echo "Event=${{ github.event_name }} | Local Europe/Madrid time now: $NOW_HM | target: $TARGET_HM"

          within_window() {
            # allow 10-minute window starting at 19:05 -> [19:05, 19:15)
            now_s=$(TZ=Europe/Madrid date -d "today $NOW_HM" +%s)
            tgt_s=$(TZ=Europe/Madrid date -d "today $TARGET_HM" +%s)
            diff=$(( now_s - tgt_s ))
            [ $diff -ge 0 ] && [ $diff -lt 600 ]  # 0..599 seconds
          }

          if [ "${{ github.event_name }}" = "schedule" ]; then
            if ! within_window; then
              echo "RUN_JOB=false" >> "$GITHUB_ENV"
              echo "Outside allowed window -> skipping."
            fi
          else
            if [ "${{ inputs.force_run }}" = "false" ] && ! within_window; then
              echo "RUN_JOB=false" >> "$GITHUB_ENV"
              echo "Manual run with force_run=false but outside window -> skipping."
            else
              echo "Manual run allowed -> proceeding."
            fi
          fi

      - name: Checkout repository
        if: ${{ env.RUN_JOB == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python
        if: ${{ env.RUN_JOB == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (jq)
        if: ${{ env.RUN_JOB == 'true' }}
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Python deps
        if: ${{ env.RUN_JOB == 'true' }}
        run: pip install .

      - name: Build booking goals (HYRO Tue on odd weeks, Wed on even)
        if: ${{ env.RUN_JOB == 'true' }}
        run: |
          TARGET_DATE=$(TZ=Europe/Madrid date -d "+${DAYS_IN_ADVANCE} day" +%F)
          ISO_WEEK=$(TZ=Europe/Madrid date -d "$TARGET_DATE" +%V)   # 01..53
          PARITY=$((10#$ISO_WEEK % 2))  # 1 = odd, 0 = even

          if [ $PARITY -eq 1 ]; then
            HYRO_INDEX="1"   # Tue
            HYRO_DAY="Tuesday"
          else
            HYRO_INDEX="2"   # Wed
            HYRO_DAY="Wednesday"
          fi
          echo "Target date: $TARGET_DATE (ISO week $ISO_WEEK) → HYRO on $HYRO_DAY"

          UPDATED=$(echo "${BOOKING_GOALS}" | jq --arg i "$HYRO_INDEX" '.[$i].name = "HYRO WOD"')
          {
            echo "BOOKING_GOALS<<EOF"
            echo "$UPDATED"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Start NordLynx + SOCKS5 proxy (Spain)
        if: ${{ env.RUN_JOB == 'true' && env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != '' }}
        run: |
          echo "Starting NordLynx proxy for country: ${NORDVPN_COUNTRY}"
          docker run -d --name nordlynx-proxy \
            --cap-add=NET_ADMIN --device /dev/net/tun \
            -e NORDVPN_LOGIN="${NORDVPN_TOKEN}" \
            -e NORDVPN_PASS="" \
            -e COUNTRY="${NORDVPN_COUNTRY}" \
            -e TECHNOLOGY=NordLynx \
            -p 1080:1080 -p 8888:8888 \
            edgd1er/nordlynx-proxy:latest-ubuntu

          echo "Waiting for SOCKS proxy to be ready on 127.0.0.1:1080 ..."
          for i in {1..40}; do
            OUT=$(curl -s --max-time 5 -x socks5://127.0.0.1:1080 https://ipinfo.io/ip || true)
            if [[ "$OUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "✅ SOCKS proxy up: $OUT"
              READY=1; break
            fi
            echo "Attempt $i/40..."; sleep 2
          done
          if [ -z "$READY" ]; then
            echo "❌ Proxy not ready. Diagnostics:"
            docker ps || true
            docker logs nordlynx-proxy || true
            exit 1
          fi
          echo "PROXY=socks5://127.0.0.1:1080" >> "$GITHUB_ENV"

          echo "Verifying geo-location through proxy..."
          INFO=$(curl -s -x socks5://127.0.0.1:1080 https://ipinfo.io/json || true)
          echo "$INFO" | jq -r '.ip, .country, .city, .org'
          EXPECTED=$(echo "$NORDVPN_COUNTRY" | tr '[:lower:]' '[:upper:]')
          GOT=$(echo "$INFO" | jq -r '.country // ""')
          if [ "$GOT" != "$EXPECTED" ]; then
            echo "⚠️ Expected $EXPECTED but got $GOT"; exit 1
          fi
          echo "✅ VPN geo check passed for $EXPECTED"

      - name: Run booking script (Sat–Wed only)
        if: ${{ env.RUN_JOB == 'true' && env.EMAIL != '' && env.PASSWORD != '' && env.BOX_NAME != '' && env.BOX_ID != '' }}
        run: |
          # %u: 1..7 (Mon..Sun). We want Sat(6), Sun(7), Mon(1), Tue(2), Wed(3).
          DOW=$(TZ=Europe/Madrid date +%u)
          if [ "$DOW" = "4" ] || [ "$DOW" = "5" ]; then
            echo "It's Thu/Fri; skipping."; exit 0
          fi

          echo "Attempting booking for +${DAYS_IN_ADVANCE} days."
          python src/main.py \
            --email "$EMAIL" \
            --password "$PASSWORD" \
            --box-name "$BOX_NAME" \
            --box-id "$BOX_ID" \
            --booking-goals "$BOOKING_GOALS" \
            --days-in-advance "$DAYS_IN_ADVANCE" \
            ${FAMILY_ID:+--family-id "$FAMILY_ID"} \
            ${PROXY:+--proxy "$PROXY"}

      - name: Cleanup NordVPN
        if: always()
        run: |
          docker rm -f nordlynx-proxy || true
          echo "NordVPN container removed"

      - name: Post-run note if skipped/misconfigured
        if: ${{ env.RUN_JOB != 'true' || env.EMAIL == '' || env.PASSWORD == '' || env.BOX_NAME == '' || env.BOX_ID == '' || env.NORDVPN_TOKEN == '' || env.NORDVPN_COUNTRY == '' }}
        run: |
          echo "Skipped or missing secrets. RUN_JOB=${RUN_JOB:-false}. Event=${{ github.event_name }}."
