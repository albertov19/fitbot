name: Book 7AM Classes (Sat–Wed)

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: "Run immediately (ignore ≥19:05 Europe/Madrid gate)"
        type: boolean
        default: false

  schedule:
    # GitHub Actions cron is UTC.
    # For Europe/Madrid WINTER time (UTC+1): 17:30 UTC = 18:30 local
    - cron: "30 17 * * 6,0-3"
    # For SUMMER time (UTC+2), switch manually to:
    # - cron: "30 16 * * 6,0-3"  # 16:30 UTC = 18:30 local

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      run_job: ${{ steps.gate.outputs.run_job }}
    steps:
      - name: Wait until Europe/Madrid ≥19:05 (Sat–Wed)
        id: gate
        shell: bash
        run: |
          run_job=true

          TARGET_HM="19:05"
          TZSTR="Europe/Madrid"

          # Day of week: 1..7 (Mon..Sun)
          DOW=$(TZ=$TZSTR date +%u)

          echo "Event=${{ github.event_name }} | TZ=$TZSTR | DOW=$DOW"

          # Sat(6), Sun(7), Mon(1), Tue(2), Wed(3)
          is_sat_to_wed() {
            [ "$DOW" = "6" ] || [ "$DOW" = "7" ] || [ "$DOW" = "1" ] || [ "$DOW" = "2" ] || [ "$DOW" = "3" ]
          }

          if ! is_sat_to_wed; then
            echo "Not Sat–Wed -> skipping workflow."
            run_job=false
          else
            FORCE_RUN="${{ inputs.force_run }}"

            # Only wait when:
            # - it's a scheduled event, OR
            # - it's a manual dispatch with force_run != true
            if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$FORCE_RUN" = "true" ]; then
              echo "Manual run with force_run=true -> skipping wait for $TARGET_HM."
            else
              echo "Ensuring local time is >= $TARGET_HM before continuing..."
              while true; do
                NOW_S=$(TZ=$TZSTR date +%s)
                TGT_S=$(TZ=$TZSTR date -d "today $TARGET_HM" +%s)
                NOW_HM=$(TZ=$TZSTR date +'%H:%M')

                if [ "$NOW_S" -ge "$TGT_S" ]; then
                  echo "Reached target time: now $NOW_HM >= $TARGET_HM. Proceeding."
                  break
                fi

                REM_SECS=$((TGT_S - NOW_S))
                if [ "$REM_SECS" -lt 0 ]; then
                  # Safety: in case of any weird clock math, don't loop forever
                  echo "Current time $NOW_HM appears past target, but comparison failed. Proceeding anyway."
                  break
                fi

                REM_MINS=$(( REM_SECS / 60 ))
                echo "Now $NOW_HM < $TARGET_HM (~$REM_MINS min remaining). Sleeping 5 minutes..."
                sleep 300
              done
            fi
          fi

          echo "run_job=$run_job" >> "$GITHUB_OUTPUT"

  book:
    needs: gate
    if: ${{ needs.gate.outputs.run_job == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      EMAIL: ${{ secrets.EMAIL }}
      PASSWORD: ${{ secrets.PWD }}
      BOX_NAME: ${{ secrets.BOX_NAME }}
      BOX_ID: ${{ secrets.BOX_ID }}
      FAMILY_ID: ${{ secrets.FAMILY_ID }}
      NORDVPN_TOKEN: ${{ secrets.NORD_TOKEN }}
      NORDVPN_COUNTRY: ${{ secrets.NORD_COUNTRY }} # e.g., ES
      BOOKING_GOALS: '{"0":{"time":"0700","name":"CrossFit"},"1":{"time":"0700","name":"CrossFit"},"2":{"time":"0700","name":"CrossFit"},"3":{"time":"0700","name":"CrossFit"},"4":{"time":"0700","name":"CrossFit"}}'
      DAYS_IN_ADVANCE: 2
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system deps (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install Python deps
        run: pip install .

      - name: Build booking goals (HYRO Tue on odd weeks, Wed on even)
        run: |
          TARGET_DATE=$(TZ=Europe/Madrid date -d "+${DAYS_IN_ADVANCE} day" +%F)
          ISO_WEEK=$(TZ=Europe/Madrid date -d "$TARGET_DATE" +%V)   # 01..53
          PARITY=$((10#$ISO_WEEK % 2))  # 1 = odd, 0 = even

          if [ $PARITY -eq 1 ]; then
            HYRO_INDEX="1"   # Tue
            HYRO_DAY="Tuesday"
          else
            HYRO_INDEX="2"   # Wed
            HYRO_DAY="Wednesday"
          fi
          echo "Target date: $TARGET_DATE (ISO week $ISO_WEEK) → HYRO on $HYRO_DAY"

          UPDATED=$(echo "${BOOKING_GOALS}" | jq --arg i "$HYRO_INDEX" '.[$i].name = "HYRO WOD"')
          {
            echo "BOOKING_GOALS<<EOF"
            echo "$UPDATED"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Start NordLynx + SOCKS5 proxy (Spain)
        if: ${{ env.NORDVPN_TOKEN != '' && env.NORDVPN_COUNTRY != '' }}
        shell: bash
        run: |
          echo "Starting NordLynx proxy for country: ${NORDVPN_COUNTRY}"
          # Consider pinning a tag you trust instead of latest-ubuntu
          docker run -d --name nordlynx-proxy \
            --cap-add=NET_ADMIN --device /dev/net/tun \
            -e NORDVPN_LOGIN="${NORDVPN_TOKEN}" \
            -e NORDVPN_PASS="" \
            -e COUNTRY="${NORDVPN_COUNTRY}" \
            -e TECHNOLOGY=NordLynx \
            -p 1080:1080 -p 8888:8888 \
            edgd1er/nordlynx-proxy:latest-ubuntu

          echo "Waiting for SOCKS proxy to be ready on 127.0.0.1:1080 ..."
          for i in {1..40}; do
            # Use socks5h so DNS resolves via proxy; add retries
            OUT=$(curl -sS --retry 3 --retry-connrefused --retry-delay 1 --max-time 5 \
                  -x socks5h://127.0.0.1:1080 https://ipinfo.io/ip || true)
            if [[ "$OUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "✅ SOCKS proxy up: $OUT"
              READY=1; break
            fi
            echo "Attempt $i/40..."; sleep 2
          done
          if [ -z "$READY" ]; then
            echo "❌ Proxy not ready. Diagnostics:"
            docker ps || true
            docker logs nordlynx-proxy || true
            exit 1
          fi
          # Keep external proxy var as socks5:// for your Python script
          echo "PROXY=socks5://127.0.0.1:1080" >> "$GITHUB_ENV"

          echo "Verifying geo-location through proxy..."
          PROXY_URL="socks5h://127.0.0.1:1080"

          # Helper to fetch country code from several providers with retries; returns 2-letter code or empty
          get_country() {
            # ipinfo.io (may rate-limit)
            BODY=$(curl -sS --fail --retry 3 --retry-connrefused --retry-delay 1 \
                        --connect-timeout 5 --max-time 10 \
                        -x "$PROXY_URL" https://ipinfo.io/json || true)
            CODE=$(echo "$BODY" | jq -r '.country // empty') && [ -n "$CODE" ] && echo "$CODE" && return 0

            # ifconfig.co
            BODY=$(curl -sS --fail --retry 3 --retry-connrefused --retry-delay 1 \
                        --connect-timeout 5 --max-time 10 \
                        -x "$PROXY_URL" https://ifconfig.co/json || true)
            CODE=$(echo "$BODY" | jq -r '.country_iso // empty') && [ -n "$CODE" ] && echo "$CODE" && return 0

            # ip-api.com (HTTP)
            BODY=$(curl -sS --fail --retry 3 --retry-connrefused --retry-delay 1 \
                        --connect-timeout 5 --max-time 10 \
                        -x "$PROXY_URL" http://ip-api.com/json || true)
            CODE=$(echo "$BODY" | jq -r '.countryCode // empty') && [ -n "$CODE" ] && echo "$CODE" && return 0

            # ip.sb
            BODY=$(curl -sS --fail --retry 3 --retry-connrefused --retry-delay 1 \
                        --connect-timeout 5 --max-time 10 \
                        -x "$PROXY_URL" https://api.ip.sb/geoip || true)
            CODE=$(echo "$BODY" | jq -r '.country_code // empty') && [ -n "$CODE" ] && echo "$CODE" && return 0

            echo ""
            return 1
          }

          # Also print proxy IP (best-effort, two sources, with retries)
          IP=$(curl -sS --fail --retry 3 --retry-connrefused --retry-delay 1 \
                    --connect-timeout 5 --max-time 10 \
                    -x "$PROXY_URL" https://ifconfig.me || true)
          [ -z "$IP" ] && IP=$(curl -sS --fail --retry 3 --retry-connrefused --retry-delay 1 \
                                  --connect-timeout 5 --max-time 10 \
                                  -x "$PROXY_URL" https://ipinfo.io/ip || true)
          [ -n "$IP" ] && echo "Proxy IP: $IP"

          EXPECTED=$(echo "$NORDVPN_COUNTRY" | tr '[:lower:]' '[:upper:]')
          GOT=$(get_country || true)
          echo "Country via proxy: ${GOT:-<unknown>} (expected $EXPECTED)"

          # Do NOT fail the job on geo-check; warn only
          if [ -z "$GOT" ]; then
            echo "⚠️  Could not determine country (providers returned non-JSON or empty). Continuing anyway."
          elif [ "$GOT" != "$EXPECTED" ]; then
            echo "⚠️  Expected $EXPECTED but got $GOT. Continuing anyway."
          else
            echo "✅ VPN geo check passed for $EXPECTED"
          fi

      - name: Run booking script
        run: |
          echo "Attempting booking for +${DAYS_IN_ADVANCE} days."
          python src/main.py \
            --email "$EMAIL" \
            --password "$PASSWORD" \
            --box-name "$BOX_NAME" \
            --box-id "$BOX_ID" \
            --booking-goals "$BOOKING_GOALS" \
            --days-in-advance "$DAYS_IN_ADVANCE" \
            ${FAMILY_ID:+--family-id "$FAMILY_ID"} \
            ${PROXY:+--proxy "$PROXY"}

      - name: Cleanup NordVPN
        if: always()
        run: docker rm -f nordlynx-proxy || true
